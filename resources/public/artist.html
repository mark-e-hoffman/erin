<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Erin :: Artists</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.5.0/pure-min.css">
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script type="text/javascript" src="js/dust.js"></script>
    <script type="text/javascript" src="js/purl.js"></script>
    <!--[if lt IE 9]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
</head>
<body>

<script id="entry-template">
     <form class="pure-form pure-form-aligned" id="artist-form">
        <fieldset>
             <legend>Artist - {_msg}</legend>
              <div class="pure-control-group">
                <label for="id">Id</label>
                <input type="text" name="id" id="id" placeholder="Id" readonly value="{id}">
             </div>
             <div class="pure-control-group">
                <label for="genre">Genre</label>
                <input type="text" name="genre" id="genre" placeholder="Genre" value="{genre}">
             </div>
             <div class="pure-control-group">
                <label for="role">Role</label>
                <input type="text" name="role" id="role" placeholder="Role" value="{role}">
             </div>
             <div class="pure-control-group">
                <label for="role">Band/Group</label>
                <input type="text" name="band_group" id="band_group" placeholder="Band/Group" value="{band_group}">
             </div>
             <div class="pure-control-group">
                <label for="role">Title</label>
                <input type="text" name="title" id="title" placeholder="Title" value="{title}">
             </div>

            <div class="pure-controls">
                <button type="submit" class="pure-button pure-button-primary">Add/Update</button>
             </div>
     </fieldset>
     </form>
</script>

<div id="output"></div>
<div id="exception"></div>

</body>
<script>

    function toJSON(o) {
        var j = {};
        for ( var i in o ) {
            if ( o[i].name != undefined && o[i].value != undefined) {
                j[o[i].name] = o[i].value;
            }

        }
        return JSON.stringify(j);
    }
    function sendForm(event) {
        alert("sending");
        event.preventDefault();
        var serialized = $('#artist-form').serializeArray();
        var id = serialized.filter(function (elem) { return elem.name == "id" });
        alert(id[0].value);

    }
    function postForm(event) {
        event.preventDefault();
         var dataToBeSent = toJSON($('#artist-form').serializeArray());
        $.ajax({
           type: "POST",
            url: 'http://localhost:3000/erin/artists',
            headers: {
                "Content-Type" : "application/json"
            },
            success: function(data) {
                alert("ok:" + data);
            },
            data: dataToBeSent,
            fail: function(err) {
                alert("fail:" + err.status);
            },
            error: function(XMLHttpRequest, textStatus, errorThrown) {
               $('#exception').html(XMLHttpRequest.responseText);
            }

        });
    }
    function putForm() {

        event.preventDefault();
        var serialized = $('#artist-form').serializeArray();

        var id = serialized.filter(function (elem) { return elem.name == "id" })[0].value;

        var dataToBeSent = toJSON(serialized);
        $.ajax({
            type: "PUT",
            url: 'http://localhost:3000/erin/artists/' + id,
            headers: {
                "Content-Type" : "application/json"
            },
            success: function(data) {
                window.location.replace("http://localhost:3000/artist.html?id=" + id + "&_msg=Update%20Successful");
            },
            data: dataToBeSent,
            error: function(XMLHttpRequest, textStatus, errorThrown) {
                $('#exception').html(XMLHttpRequest.responseText);
            },
            fail: function(err) {
                alert("fail:" + err.status);
            }

        });
    }
    $(document).ready(function() {
        // jQuery example

        var id = $.url().param('id');
        var msg = $.url().param('_msg');
        var source = $("#entry-template").html();
        var compiled = dust.compile(source, "artist");
        dust.loadSource(compiled);
        if ( id ) {
            $.getJSON("http://localhost:3000/erin/artists/" + id, function (data) {
                data["_msg"] = msg;
                dust.render("artist", data, function (err, out) {
                    $("#output").html(out);
                    $("#artist-form").submit(putForm);
                });


            })
                    .fail(function (err) {
                        if (err.status == 404) {
                            alert("Cannot locate artist by id " + id);
                        }
                    })
                    .error(function(XMLHttpRequest, textStatus, errorThrown) {
                        $('#exception').html(XMLHttpRequest.responseText);
                    })
            ;
        } else { // render an empty form for adding a new record
            dust.render("artist", {}, function (err, out) {
                $("#output").html(out);
                $("#artist-form").submit(postForm);
            });
        }


    });





</script>
</html>
